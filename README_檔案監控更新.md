# 檔案監控機制更新說明

## 🎯 問題解決

### 原本的問題
- 儀器插著時，新檔案無法自動讀取
- 需要手動重新掛載才能看到新檔案
- Mac 和 Windows 都有此問題

### 解決方案
改用 **即時檔案系統監控** 取代定期掃描 + 重新掛載的方式

---

## ✨ 新功能特點

### 1. **即時監控** (主要機制)
- 使用 `watchdog` 套件監控檔案系統事件
- 當儀器產生新的 `.res` 檔案時，**立即偵測並處理**
- 不需要等待掃描週期，也不需要重新掛載

### 2. **定期掃描** (備援機制)
- 保留原本的定期掃描功能
- 作為即時監控的備援（以防監控失效）
- 預設每 300 秒掃描一次

### 3. **跨平台支援**
- ✅ Mac (macOS)
- ✅ Windows
- ✅ Linux

---

## 🔧 技術細節

### 監控機制
```python
class ResFileHandler(FileSystemEventHandler):
    def on_created(self, event):
        # 當新檔案建立時觸發
        
    def on_modified(self, event):
        # 當檔案被修改時觸發（處理先建立空檔再寫入的情況）
```

### 雙重保護
1. **即時監控**：檔案一產生就處理
2. **定期掃描**：每 5 分鐘檢查一次，確保沒有遺漏

### 防重複處理
- 使用 `threading.Lock()` 確保同一檔案不會被重複處理
- 檢查 `processed_history.txt` 避免重複匯入

---

## 📦 安裝需求

需要安裝 `watchdog` 套件：

```bash
pip3 install watchdog
```

---

## 🚀 使用方式

### 啟動程式
```bash
python3 app.py
```

### 監控狀態顯示
程式啟動後會在系統監控紀錄區顯示：
- `✅ 即時檔案監控已啟動` - 即時監控成功啟動
- `🔄 定期掃描已啟動 (間隔: 300秒)` - 備援掃描已啟動

### 檔案偵測訊息
- `🔔 偵測到新檔案: xxx.res` - 即時監控偵測到新檔案
- `📝 檔案已更新: xxx.res` - 檔案內容更新
- `🔎 定期掃描發現 N 個新檔案` - 定期掃描發現遺漏的檔案

---

## 🔄 手動刷新功能

雖然新機制不需要重新掛載，但仍保留手動刷新按鈕：
- 按鈕：`🔄 強制刷新儀器 (Remount)`
- 用途：當懷疑檔案系統有問題時，可手動觸發重新掛載（僅限 Mac）

---

## ⚙️ 設定調整

在 `app.py` 的設定區可調整：

```python
# 儀器磁碟機的根目錄
VOLUME_PATH = '/Volumes/QTEST1A9166' 

# 實際存放 RES 檔案的資料夾
SOURCE_FOLDER = os.path.join(VOLUME_PATH, 'Log')

# 定期掃描間隔（秒）
CHECK_INTERVAL = 300
```

---

## 🐛 故障排除

### 如果即時監控無法啟動
- 程式會自動降級使用定期掃描模式
- 檢查 `SOURCE_FOLDER` 路徑是否正確
- 確認已安裝 `watchdog` 套件

### Windows 使用注意事項
- 確保儀器磁碟機已正確掛載（例如 `D:\` 或 `E:\`）
- 修改 `VOLUME_PATH` 為 Windows 路徑格式：
  ```python
  VOLUME_PATH = 'D:\\'  # 或你的儀器磁碟機代號
  SOURCE_FOLDER = os.path.join(VOLUME_PATH, 'Log')
  ```

### Mac 使用注意事項
- 路徑格式：`/Volumes/磁碟機名稱`
- 手動刷新功能僅在 Mac 上可用（使用 `diskutil` 命令）

---

## 📊 效能優勢

| 項目 | 舊機制 | 新機制 |
|------|--------|--------|
| 反應時間 | 最長 300 秒 | **即時（< 2 秒）** |
| 系統負擔 | 每 5 分鐘重新掛載 | **無需重新掛載** |
| 跨平台 | 僅 Mac | **Mac + Windows** |
| 可靠性 | 依賴重新掛載 | **雙重保護** |

---

## 📝 更新日誌

### 2026-01-29
- ✅ 新增即時檔案系統監控
- ✅ 移除自動重新掛載機制
- ✅ 改善跨平台相容性
- ✅ 新增雙重監控機制（即時 + 定期）
- ✅ 優化效能與反應速度
